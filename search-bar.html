<!-- BARRE DE RECHERCHE INTELLIGENTE -->
<div class="smart-search-container">
    <div class="search-toggle" id="search-toggle">
        <i class="fas fa-search"></i>
    </div>
    
    <div class="search-overlay" id="search-overlay">
        <div class="search-modal">
            <div class="search-header">
                <h3>Recherche intelligente</h3>
                <button class="close-search" id="close-search">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="search-input-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="global-search" placeholder="Que recherchez-vous?" autocomplete="off">
                <div class="search-voice">
                    <i class="fas fa-microphone"></i>
                </div>
            </div>
            
            <div class="search-results" id="search-results">
                <div class="search-categories">
                    <button class="category-tab active" data-category="all">Tout</button>
                    <button class="category-tab" data-category="pages">Pages</button>
                    <button class="category-tab" data-category="faq">FAQ</button>
                    <button class="category-tab" data-category="community">Communauté</button>
                </div>
                
                <div class="loading-indicator">
                    <div class="spinner"></div>
                    <p>Recherche en cours...</p>
                </div>
                
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <p>Aucun résultat trouvé. Essayez d'autres termes ou posez votre question à notre assistant.</p>
                </div>
                
                <div class="results-container">
                    <!-- Les résultats seront affichés ici dynamiquement -->
                </div>

                <div class="search-ai-suggestion">
                    <div class="ai-suggestion-header">
                        <i class="fas fa-robot"></i>
                        <h4>Vous ne trouvez pas ce que vous cherchez?</h4>
                    </div>
                    <p>Notre assistant virtuel peut vous aider avec des réponses personnalisées.</p>
                    <button id="open-assistant" class="btn btn-primary">Discuter avec notre assistant</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- STYLES CSS POUR LA BARRE DE RECHERCHE -->
<style>
.smart-search-container {
    position: relative;
    z-index: 9999;
}

.search-toggle {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    z-index: 1001;
}

.search-toggle:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
}

.search-toggle i {
    font-size: 1.3rem;
}

.search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.search-overlay.active {
    opacity: 1;
    visibility: visible;
}

.search-modal {
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    background-color: white;
    border-radius: var(--border-radius-lg);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transform: translateY(50px);
    opacity: 0;
    transition: all 0.4s ease;
}

.search-overlay.active .search-modal {
    transform: translateY(0);
    opacity: 1;
}

.search-header {
    padding: var(--spacing-md) var(--spacing-lg);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--gray-light);
}

.search-header h3 {
    margin: 0;
    color: var(--secondary);
    font-size: 1.3rem;
}

.close-search {
    background: none;
    border: none;
    font-size: 1.2rem;
    color: var(--gray);
    cursor: pointer;
    transition: color 0.2s ease;
}

.close-search:hover {
    color: var(--primary);
}

.search-input-wrapper {
    padding: var(--spacing-md) var(--spacing-lg);
    display: flex;
    align-items: center;
    border-bottom: 1px solid var(--gray-light);
}

.search-input-wrapper i {
    color: var(--gray);
    margin-right: var(--spacing-sm);
    font-size: 1.1rem;
}

#global-search {
    flex: 1;
    border: none;
    font-size: 1.1rem;
    padding: var(--spacing-sm) 0;
}

#global-search:focus {
    outline: none;
}

.search-voice {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: var(--light);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.search-voice:hover {
    background-color: var(--gray-light);
}

.search-voice i {
    margin: 0;
    color: var(--primary);
}

.search-results {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-lg);
}

.search-categories {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    border-bottom: 1px solid var(--gray-light);
    padding-bottom: var(--spacing-sm);
}

.category-tab {
    background: none;
    border: none;
    padding: var(--spacing-xs) var(--spacing-sm);
    cursor: pointer;
    font-weight: 500;
    color: var(--gray);
    position: relative;
    transition: all 0.2s ease;
}

.category-tab:hover {
    color: var(--secondary);
}

.category-tab.active {
    color: var(--primary);
}

.category-tab.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: var(--primary);
}

.loading-indicator {
    display: none;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-xl) 0;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--light);
    border-top: 3px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: var(--spacing-md);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-indicator p {
    color: var(--gray);
}

.no-results {
    display: none;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-xl) 0;
    text-align: center;
}

.no-results i {
    font-size: 2.5rem;
    color: var(--gray-light);
    margin-bottom: var(--spacing-md);
}

.no-results p {
    color: var(--gray);
    max-width: 400px;
}

.results-container {
    display: none;
}

.result-item {
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-radius: var(--border-radius-md);
    background-color: var(--light);
    transition: all 0.2s ease;
}

.result-item:hover {
    background-color: rgba(230, 57, 70, 0.05);
}

.result-item h4 {
    margin: 0 0 var(--spacing-xs) 0;
    color: var(--secondary);
}

.result-item p {
    margin: 0;
    color: var(--gray);
    font-size: 0.95rem;
}

.result-item .highlight {
    background-color: rgba(255, 183, 3, 0.2);
    padding: 0 2px;
}

.result-item .category-badge {
    display: inline-block;
    font-size: 0.8rem;
    padding: 2px 8px;
    border-radius: 10px;
    background-color: var(--gray-light);
    color: var(--gray);
    margin-top: var(--spacing-xs);
}

.search-ai-suggestion {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-lg);
    background-color: var(--light);
    border-radius: var(--border-radius-md);
    border-left: 4px solid var(--primary);
}

.ai-suggestion-header {
    display: flex;
    align-items: center;
    margin-bottom: var(--spacing-sm);
}

.ai-suggestion-header i {
    font-size: 1.3rem;
    color: var(--primary);
    margin-right: var(--spacing-sm);
}

.ai-suggestion-header h4 {
    margin: 0;
    color: var(--secondary);
}

.search-ai-suggestion p {
    margin-bottom: var(--spacing-md);
    color: var(--gray);
}

/* Responsive */
@media (max-width: 768px) {
    .search-modal {
        width: 95%;
        max-height: 90vh;
    }
    
    .search-categories {
        overflow-x: auto;
        padding-bottom: var(--spacing-md);
    }
    
    .search-toggle {
        bottom: 20px;
        right: 20px;
    }
}
</style>

<!-- SCRIPT POUR LA BARRE DE RECHERCHE -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchToggle = document.getElementById('search-toggle');
    const searchOverlay = document.getElementById('search-overlay');
    const closeSearch = document.getElementById('close-search');
    const searchInput = document.getElementById('global-search');
    const searchResults = document.getElementById('search-results');
    const resultsContainer = searchResults.querySelector('.results-container');
    const loadingIndicator = searchResults.querySelector('.loading-indicator');
    const noResults = searchResults.querySelector('.no-results');
    const categoryTabs = document.querySelectorAll('.category-tab');
    const openAssistant = document.getElementById('open-assistant');
    
    // Fonction pour ouvrir la recherche
    searchToggle.addEventListener('click', function() {
        searchOverlay.classList.add('active');
        setTimeout(() => {
            searchInput.focus();
        }, 400);
    });
    
    // Fonction pour fermer la recherche
    closeSearch.addEventListener('click', function() {
        searchOverlay.classList.remove('active');
    });
    
    // Fermer la recherche en cliquant en dehors du modal
    searchOverlay.addEventListener('click', function(e) {
        if (e.target === searchOverlay) {
            searchOverlay.classList.remove('active');
        }
    });
    
    // Fermer la recherche avec la touche Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && searchOverlay.classList.contains('active')) {
            searchOverlay.classList.remove('active');
        }
    });
    
    // Recherche en temps réel
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        
        const query = this.value.trim();
        
        if (query.length < 2) {
            hideSearchResults();
            return;
        }
        
        // Délai avant de lancer la recherche pour éviter trop de requêtes
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300);
    });
    
    // Recherche avec la touche Entrée
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query.length >= 2) {
                performSearch(query);
            }
        }
    });
    
    // Changer de catégorie de résultats
    categoryTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Retirer la classe active de tous les onglets
            categoryTabs.forEach(t => t.classList.remove('active'));
            
            // Ajouter la classe active à l'onglet cliqué
            this.classList.add('active');
            
            // Filtrer les résultats selon la catégorie
            const category = this.getAttribute('data-category');
            filterResultsByCategory(category);
        });
    });
    
    // Ouvrir l'assistant virtuel
    openAssistant.addEventListener('click', function() {
        searchOverlay.classList.remove('active');
        // Ouvrir l'assistant virtuel
        openChatbot();
    });
    
    // Activer la reconnaissance vocale
    const voiceSearch = document.querySelector('.search-voice');
    if (voiceSearch && 'webkitSpeechRecognition' in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'fr-FR';
        
        voiceSearch.addEventListener('click', function() {
            recognition.start();
            voiceSearch.classList.add('listening');
        });
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            searchInput.value = transcript;
            // Déclencher l'événement input pour lancer la recherche
            searchInput.dispatchEvent(new Event('input'));
            voiceSearch.classList.remove('listening');
        };
        
        recognition.onerror = function() {
            voiceSearch.classList.remove('listening');
        };
        
        recognition.onend = function() {
            voiceSearch.classList.remove('listening');
        };
    } else {
        voiceSearch.style.display = 'none';
    }
    
    // Fonction pour effectuer la recherche
    function performSearch(query) {
        // Afficher l'indicateur de chargement
        showLoading();
        
        // Simuler un délai réseau (à remplacer par votre vraie recherche API)
        setTimeout(() => {
            // Cette partie serait remplacée par un appel à votre API de recherche
            const results = simulateSearch(query);
            
            if (results.length > 0) {
                displayResults(results, query);
            } else {
                showNoResults();
            }
        }, 700);
    }
    
    // Fonction pour afficher l'indicateur de chargement
    function showLoading() {
        resultsContainer.style.display = 'none';
        noResults.style.display = 'none';
        loadingIndicator.style.display = 'flex';
    }
    
    // Fonction pour afficher les résultats
    function displayResults(results, query) {
        loadingIndicator.style.display = 'none';
        noResults.style.display = 'none';
        
        // Vider le conteneur de résultats
        resultsContainer.innerHTML = '';
        
        // Ajouter chaque résultat
        results.forEach(result => {
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            resultItem.dataset.category = result.category;
            
            // Mettre en évidence le terme recherché
            const highlightedTitle = highlightText(result.title, query);
            const highlightedContent = highlightText(result.content, query);
            
            resultItem.innerHTML = `
                <h4>${highlightedTitle}</h4>
                <p>${highlightedContent}</p>
                <span class="category-badge">${getCategoryLabel(result.category)}</span>
            `;
            
            // Ajouter un événement de clic pour naviguer vers le résultat
            resultItem.addEventListener('click', () => {
                window.location.href = result.url;
            });
            
            resultsContainer.appendChild(resultItem);
        });
        
        resultsContainer.style.display = 'block';
        
        // Filtrer les résultats selon l'onglet actif
        const activeTab = document.querySelector('.category-tab.active');
        if (activeTab) {
            filterResultsByCategory(activeTab.getAttribute('data-category'));
        }
    }
    
    // Fonction pour afficher "aucun résultat"
    function showNoResults() {
        loadingIndicator.style.display = 'none';
        resultsContainer.style.display = 'none';
        noResults.style.display = 'flex';
    }
    
    // Fonction pour masquer les résultats
    function hideSearchResults() {
        loadingIndicator.style.display = 'none';
        resultsContainer.style.display = 'none';
        noResults.style.display = 'none';
    }
    
    // Fonction pour mettre en évidence le texte recherché
    function highlightText(text, query) {
        if (!query) return text;
        
        const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }
    
    // Échapper les caractères spéciaux pour les expressions régulières
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    // Fonction pour filtrer les résultats par catégorie
    function filterResultsByCategory(category) {
        const resultItems = resultsContainer.querySelectorAll('.result-item');
        
        resultItems.forEach(item => {
            if (category === 'all' || item.dataset.category === category) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
        
        // Vérifier s'il y a des résultats visibles
        const visibleResults = Array.from(resultItems).filter(item => 
            item.style.display !== 'none'
        );
        
        if (visibleResults.length === 0 && resultsContainer.style.display !== 'none') {
            noResults.style.display = 'flex';
        } else {
            noResults.style.display = 'none';
        }
    }
    
    // Obtenir le libellé de la catégorie
    function getCategoryLabel(category) {
        switch(category) {
            case 'pages':
                return 'Page';
            case 'faq':
                return 'FAQ';
            case 'community':
                return 'Communauté';
            default:
                return 'Autre';
        }
    }
    
    // Fonction pour ouvrir l'assistant virtuel (chatbot)
    function openChatbot() {
        // Cette fonction serait remplacée par l'ouverture de votre chatbot
        // Si vous avez un chatbot déjà intégré, vous pouvez l'ouvrir ici
        console.log('Ouvrir l\'assistant virtuel');
        
        // Si vous utilisez un chatbot comme Intercom, Zendesk, etc.
        // vous pourriez appeler leur API ici
        if (window.openChatbotWidget) {
            window.openChatbotWidget();
        } else {
            // Sinon, vous pouvez afficher un message
            alert('L\'assistant virtuel sera bientôt disponible!');
        }
    }
    
    // Fonction qui simule une recherche (à remplacer par votre API)
    function simulateSearch(query) {
        // Données de démonstration
        const allData = [
            {
                title: 'Notre concept de bunkers communautaires',
                content: 'Découvrez notre approche innovante de bunkers collectifs financés par la communauté pour protéger tous les citoyens.',
                url: 'pages/concept.html',
                category: 'pages'
            },
            {
                title: 'Rejoindre une communauté existante',
                content: 'Comment rejoindre ou initier un projet communautaire dans votre région pour construire un bunker près de chez vous.',
                url: 'pages/communaute.html',
                category: 'community'
            },
            {
                title: 'Pourquoi avons-nous besoin de bunkers en France?',
                content: 'Face aux incertitudes mondiales, la France dispose de seulement 1000 bunkers pouvant accueillir moins de 1% de la population.',
                url: 'pages/faq.html#initiative',
                category: 'faq'
            },
            {
                title: 'Comment fonctionne le modèle de financement solidaire?',
                content: 'Notre modèle repose sur des contributions volontaires, des événements de collecte, et des partenariats pour garantir l\'accès à tous.',
                url: 'pages/faq.html#communaute',
                category: 'faq'
            },
            {
                title: 'Événements communautaires à venir',
                content: 'Calendrier des prochaines loteries solidaires, courses caritatives et événements de collecte de fonds dans votre région.',
                url: 'pages/communaute.html#events',
                category: 'community'
            },
            {
                title: 'Comment contribuer si je n\'ai pas de moyens financiers importants?',
                content: 'Découvrez comment participer au projet par le partage de compétences, le don de temps ou des micro-contributions.',
                url: 'pages/faq.html#communaute',
                category: 'faq'
            }
        ];
        
        // Filtrer les résultats qui contiennent le terme de recherche
        return allData.filter(item => {
            const lowerQuery = query.toLowerCase();
            return item.title.toLowerCase().includes(lowerQuery) || 
                   item.content.toLowerCase().includes(lowerQuery);
        });
    }
});
</script>
